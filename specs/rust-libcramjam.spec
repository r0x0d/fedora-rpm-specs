# Generated by rust2rpm 27
%bcond check 1
# Build a C-API shared library with cargo-c and install it?
#
# Once we build a shared library in an EPEL release, we are almost guaranteed
# to eventually need to maintain a ccompat package to preserve its API/ABI
# stability. For the time being, we donâ€™t plan to ship a shared library in any
# EPEL release unless someone specifically asks for it.
%bcond capi %{expr:%{undefined fc40} && %{undefined fc41} && %{undefined epel}}

%global crate libcramjam

Name:           rust-libcramjam
# Even though this is just MAJOR.MINOR from the SemVer version, we repeat it
# explicitly to help prevent undetected/unannounced SONAME version bumps in the
# libcramjam/libcramjam-devel subpackages.
%global soversion 0.7
Version:        0.7.0
Release:        %autorelease
Summary:        Compression library combining a plethora of algorithms

License:        MIT
URL:            https://crates.io/crates/libcramjam
Source:         %{crates_source}
# Manually created patch for downstream crate metadata changes
# * Add crate-type = ["lib", "cdylib"] to the [lib] table to get a better
#   template from rust2rpm
# * Do not upper-bound the version of libdeflate-sys (which is only due to CI
#   limitations)
# * Patch out all -static features
# * Patch out features requiring blosc2-rs or isal-rs so we can stop packaging
#   those crates
Patch:          libcramjam-fix-metadata.diff

# https://fedoraproject.org/wiki/Changes/EncourageI686LeafRemoval
ExcludeArch:    %{ix86}

BuildRequires:  cargo-rpm-macros >= 24
BuildRequires:  cargo-c

%global _description %{expand:
Compression library combining a plethora of algorithms in a similar as
possible API.}

%description %{_description}

%if %{with capi}
%package     -n %{crate}
Summary:        %{summary}
# 0BSD OR MIT OR Apache-2.0
# Apache-2.0
# BSD-3-Clause
# BSD-3-Clause AND MIT
# MIT
# MIT OR Apache-2.0
# MIT OR Zlib OR Apache-2.0
License:        %{shrink:
                (0BSD OR MIT OR Apache-2.0) AND
                Apache-2.0 AND
                BSD-3-Clause AND
                MIT AND
                (MIT OR Apache-2.0) AND
                (MIT OR Zlib OR Apache-2.0)
                }
# LICENSE.dependencies contains a full license breakdown

%description -n %{crate} %{_description}

This package contains libraries for using the "%{crate}" crate via a C API.

%files       -n %{crate}
%license LICENSE
%license LICENSE.dependencies
%doc README.md
%{_libdir}/%{crate}.so.%{soversion}{,.*}

%package     -n %{crate}-devel
Summary:        %{summary}

Requires:       %{crate}%{?_isa} = %{version}-%{release}

%description -n %{crate}-devel %{_description}

This package contains libraries and header files for developing applications
that use the "%{crate}" crate via a C API.

%files       -n %{crate}-devel
%{_includedir}/cramjam/cramjam.h
%{_libdir}/%{crate}.so
%{_libdir}/pkgconfig/%{crate}.pc
%else
%global debug_package %{nil}
%endif

%package        devel
Summary:        %{summary}
BuildArch:      noarch

%description    devel %{_description}

This package contains library source intended for building other packages which
use the "%{crate}" crate.

%files          devel
%license %{crate_instdir}/LICENSE
%doc %{crate_instdir}/README.md
%{crate_instdir}/

%package     -n %{name}+default-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+default-devel %{_description}

This package contains library source intended for building other packages which
use the "default" feature of the "%{crate}" crate.

%files       -n %{name}+default-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+brotli-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+brotli-devel %{_description}

This package contains library source intended for building other packages which
use the "brotli" feature of the "%{crate}" crate.

%files       -n %{name}+brotli-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+bzip2-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+bzip2-devel %{_description}

This package contains library source intended for building other packages which
use the "bzip2" feature of the "%{crate}" crate.

%files       -n %{name}+bzip2-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+capi-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+capi-devel %{_description}

This package contains library source intended for building other packages which
use the "capi" feature of the "%{crate}" crate.

%files       -n %{name}+capi-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+deflate-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+deflate-devel %{_description}

This package contains library source intended for building other packages which
use the "deflate" feature of the "%{crate}" crate.

%files       -n %{name}+deflate-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+deflate-shared-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+deflate-shared-devel %{_description}

This package contains library source intended for building other packages which
use the "deflate-shared" feature of the "%{crate}" crate.

%files       -n %{name}+deflate-shared-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+gzip-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+gzip-devel %{_description}

This package contains library source intended for building other packages which
use the "gzip" feature of the "%{crate}" crate.

%files       -n %{name}+gzip-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+gzip-shared-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+gzip-shared-devel %{_description}

This package contains library source intended for building other packages which
use the "gzip-shared" feature of the "%{crate}" crate.

%files       -n %{name}+gzip-shared-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+lz4-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+lz4-devel %{_description}

This package contains library source intended for building other packages which
use the "lz4" feature of the "%{crate}" crate.

%files       -n %{name}+lz4-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+snappy-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+snappy-devel %{_description}

This package contains library source intended for building other packages which
use the "snappy" feature of the "%{crate}" crate.

%files       -n %{name}+snappy-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+xz-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+xz-devel %{_description}

This package contains library source intended for building other packages which
use the "xz" feature of the "%{crate}" crate.

%files       -n %{name}+xz-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+xz-shared-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+xz-shared-devel %{_description}

This package contains library source intended for building other packages which
use the "xz-shared" feature of the "%{crate}" crate.

%files       -n %{name}+xz-shared-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+zlib-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+zlib-devel %{_description}

This package contains library source intended for building other packages which
use the "zlib" feature of the "%{crate}" crate.

%files       -n %{name}+zlib-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+zlib-shared-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+zlib-shared-devel %{_description}

This package contains library source intended for building other packages which
use the "zlib-shared" feature of the "%{crate}" crate.

%files       -n %{name}+zlib-shared-devel
%ghost %{crate_instdir}/Cargo.toml

%package     -n %{name}+zstd-devel
Summary:        %{summary}
BuildArch:      noarch

%description -n %{name}+zstd-devel %{_description}

This package contains library source intended for building other packages which
use the "zstd" feature of the "%{crate}" crate.

%files       -n %{name}+zstd-devel
%ghost %{crate_instdir}/Cargo.toml

%prep
%autosetup -n %{crate}-%{version} -p1
%cargo_prep

%generate_buildrequires
%cargo_generate_buildrequires -a

%build
%cargo_build -a
%{cargo_license_summary -a}
%{cargo_license -a} > LICENSE.dependencies
%if %{with capi}
%cargo_cbuild -a
%endif

%install
%cargo_install -a
%if %{with capi}
%cargo_cinstall -a
# https://docs.fedoraproject.org/en-US/packaging-guidelines/#packaging-static-libraries
rm '%{buildroot}%{_libdir}/%{crate}.a'
%endif

%if %{with check}
%check
%cargo_test -a
%endif

%changelog
%autochangelog
