Name:		rtpproxy
Version:	3.0.1
Release:	%autorelease
Summary:	A symmetric RTP proxy
License:        BSD-2-Clause
URL:		http://www.rtpproxy.org
VCS:		git:https://github.com/sippy/rtpproxy.git
Source0:	https://github.com/sippy/rtpproxy/archive/v%{version}/%{name}-%{version}.tar.gz
Source1:	https://github.com/sippy/hepconnector/archive/395e565b565ec222baa22bf0b8b67d7c812fe0a2/hepconnector-0.tar.gz
Source2:	https://github.com/sobomax/libelperiodic/archive/v1.4/libelperiodic-1.4.tar.gz
Source3:	rtpproxy.sysusers
Patch1:		rtpproxy-0001-Remove-more-autogenerated-stuff.patch
Patch2:		rtpproxy-0002-Fedora-related-fix-for-docbook-path.patch
Patch3:		rtpproxy-0003-Hardcode-Git-short-commit-in-configure.ac.patch
Patch4:		rtpproxy-0004-Reverse-debug-nodebug-flags.patch
Patch5:		rtpproxy-0005-Remove-bundled-libucl.patch
Patch6:		rtpproxy-0006-Remove-bundled-xxHash.patch
Patch7:		rtpproxy-0007-Missing-include.patch
Patch8:		rtpproxy-0008-Fix-run-tmp-directory-creation.-On-upgrade-this-mess.patch
Patch9:		rtpproxy-0009-Get-rid-of-deprecated-ATOMIC_VAR_INIT-use-_Atomic-ty.patch
BuildRequires:	autoconf
BuildRequires:	automake
BuildRequires:	bcg729-devel
BuildRequires:	docbook-style-xsl
BuildRequires:	gcc
BuildRequires:	gsm-devel
BuildRequires:	libsndfile-devel
BuildRequires:	libsrtp-devel
BuildRequires:	libtool
BuildRequires:	libucl-devel >= 0.8.2
BuildRequires:	libxslt
BuildRequires:	make
BuildRequires:	openssl-devel
BuildRequires:	systemd-devel
BuildRequires:	systemd-rpm-macros
BuildRequires:	xxhash-devel
Requires(pre):	/usr/sbin/useradd
Requires(post): systemd
Requires(preun): systemd
Requires(postun): systemd


%description
This is symmetric RTP proxy designed to be used in conjunction with
the SIP Express Router (SER) or any other SIP proxy capable of
rewriting SDP bodies in SIP messages that it processes.


%prep
%autosetup -p1
cd hepconnector
tar xvf %{SOURCE1}  --strip-components 1
cd ..
cd libelperiodic
tar xvf %{SOURCE2}  --strip-components 1
cd ..

%build
autoreconf -ivf
%configure --enable-systemd --disable-static
%make_build
make rtpproxy.8


%install
%make_install
install -D -p -m 0644 rpm/%{name}.sysconfig %{buildroot}%{_sysconfdir}/sysconfig/%{name}
# install systemd files
install -D -m 0644 -p rpm/%{name}.service %{buildroot}%{_unitdir}/%{name}.service
install -D -m 0644 -p rpm/%{name}.socket %{buildroot}%{_unitdir}/%{name}.socket
install -D -m 0644 -p rpm/%{name}.tmpfiles.conf %{buildroot}%{_tmpfilesdir}/%{name}.conf
mkdir -p %{buildroot}%{_localstatedir}/run/%{name}
install -d %{buildroot}%{_localstatedir}/lib/%{name}
install -p -D -m 0644 %{SOURCE3} %{buildroot}%{_sysusersdir}/%{name}.conf


%pre
%sysusers_create_compat %{SOURCE3}


%post
%systemd_post %{name}.service


%preun
%systemd_preun %{name}.service


%files
%doc AUTHORS README.md README.remote
%license LICENSE
%config(noreplace) %{_sysconfdir}/sysconfig/%{name}
%{_unitdir}/%{name}.service
%{_unitdir}/%{name}.socket
%{_tmpfilesdir}/%{name}.conf
%dir %attr(0755, rtpproxy, rtpproxy) %{_localstatedir}/run/%{name}
%{_bindir}/extractaudio
%{_bindir}/makeann
%{_bindir}/rtpproxy
%exclude %{_bindir}/rtpproxy_debug
%ifarch %{ix86} x86_64
# requires rdtsc which is available only on x86/x86_64 arches
%{_bindir}/udp_contention
%endif
%{_sysusersdir}/%{name}.conf
%{_libdir}/rtpproxy/*.so
%exclude %{_libdir}/libelperiodic.so
%{_libdir}/libelperiodic.so.1
%{_libdir}/libelperiodic.so.1.0.0
%{_mandir}/man8/rtpproxy.8*
%dir %attr(0750, rtpproxy, rtpproxy) %{_localstatedir}/lib/%{name}


%changelog
%autochangelog
